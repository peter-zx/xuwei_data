# 公式列名映射问题修复说明

## 问题描述

用户在上传包含公式的 Excel 文件后，在"数据映射"环节发现部分列（残疾证号、残疾类型、残疾等级等）的数据为空，无法正确映射。

## 问题分析

### 1. 公式数据本身正常

通过分析发现，原始 Excel 文件中的公式已被 pandas 正确计算：

```python
# 原始数据检查
'残疾证号\n（自动填充无需输入）': 
  ['42011520000720008641', '42098419880825732912', '41130319830724393941', ...]

'残疾类型\n（自动填充）': 
  ['肢体', '视力', '肢体', ...]

'残疾等级\n（自动填充）': 
  ['一级', '二级', '一级', ...]
```

**结论：公式已被正确计算，数据存在。**

### 2. 列名问题

实际列名包含换行符和括号备注：

```
原始列名：
- '残疾证号\n（自动填充无需输入）'
- '残疾类型\n（自动填充）'
- '残疾等级\n（自动填充）'
- '残疾证到期时间\n（有效期十年）\n自动填充'

用户在映射配置时选择的简化列名：
- '残疾证号'
- '残疾类型'
- '残疾等级'
- '残疾证到期时间'
```

**问题：列名不匹配，导致映射失败，数据为空。**

## 解决方案

### 方案设计

实现智能列名映射机制：

1. **列名清理**：自动去除括号及括号内容、换行符等
2. **映射字典**：创建 `清理后列名 → 原始列名` 的映射关系
3. **智能查找**：映射时通过清理后的列名查找原始列名

### 代码实现

#### 1. 列名清理函数

```python
import re

def clean_column_name(col_name):
    """清理列名：去除换行符、多余空格"""
    text = str(col_name).replace('\n', ' ').replace('\r', ' ').replace('\t', ' ')
    text = text.strip()
    while '  ' in text:
        text = text.replace('  ', ' ')
    return text

# 列名简化（去除括号及括号内容）
col_name_clean = re.sub(r'[（(].*?[）)]', '', col_name)
col_name_clean = col_name_clean.strip()
```

**效果：**
```
'残疾证号\n（自动填充无需输入）' → '残疾证号'
'残疾类型\n（自动填充）' → '残疾类型'
```

#### 2. 列名映射字典

```python
# 创建列名映射字典（清理后的列名 → 原始列名）
col_name_map = {}
for orig_col in df.columns:
    cleaned_col = clean_column_name(orig_col)
    cleaned_col = re.sub(r'[（(].*?[）)]', '', cleaned_col).strip()
    if cleaned_col:
        col_name_map[cleaned_col] = orig_col

# 结果示例
col_name_map = {
    '残疾证号': '残疾证号\n（自动填充无需输入）',
    '残疾类型': '残疾类型\n（自动填充）',
    '残疾等级': '残疾等级\n（自动填充）',
    ...
}
```

#### 3. 映射时智能查找

```python
for field in get_standard_fields():
    col_name = field_mapping.get(field)  # 用户选择的简化列名
    if col_name and col_name.strip():
        # 通过映射字典查找原始列名
        orig_col = col_name_map.get(col_name, col_name)
        
        if orig_col in df.columns:
            value = row[orig_col]  # 使用原始列名获取数据
            # ... 处理数据
```

### 应用范围

该方案已应用到以下接口：

1. **`/api/columns`** - 获取列名列表时清理列名
2. **`/api/analyze`** - 数据映射时智能查找原始列名
3. **`/api/compare`** - 数据比对时智能查找原始列名

## 技术要点

### 1. 正则表达式清理

```python
# 匹配中文括号和英文括号及其内容
re.sub(r'[（(].*?[）)]', '', col_name)
```

- `[（(]` - 匹配中文括号 `（` 或英文括号 `(`
- `.*?` - 非贪婪匹配任意字符
- `[）)]` - 匹配中文括号 `）` 或英文括号 `)`

### 2. 映射优先级

```python
orig_col = col_name_map.get(col_name, col_name)
```

1. 优先在映射字典中查找
2. 如果找不到，使用原始列名（兼容普通列名）

### 3. 数据处理流程

```
原始Excel文件
    ↓
pandas读取（自动计算公式）
    ↓
创建列名映射字典
    ↓
用户配置映射（简化列名）
    ↓
通过字典查找原始列名
    ↓
正确获取数据
```

## 测试验证

### 测试数据

- 文件：徐唯信息总表
- Sheet：徐唯信息总表
- 行数：276条

### 测试结果

✅ 列名正确显示（已清理）
```
序列, 备注, 介绍人, 残疾人姓名, 本人电话, 身份证号码, 
残疾证号, 残疾类型, 残疾等级, ...
```

✅ 数据正确映射
```
残疾证号: ['42011520000720008641', '42098419880825732912', ...]
残疾类型: ['肢体', '视力', '肢体', ...]
残疾等级: ['一级', '二级', '一级', ...]
```

## 总结

本问题的根本原因是 **列名包含换行符和括号备注**，导致用户配置的简化列名无法匹配实际列名。

解决方案的核心是 **智能列名映射机制**：

1. 自动清理列名，去除括号备注
2. 建立清理后列名与原始列名的映射关系
3. 映射时通过字典智能查找原始列名

该方案具有以下优点：

- ✅ 用户友好：显示简化的列名，便于选择
- ✅ 兼容性强：同时支持包含括号和不包含括号的列名
- ✅ 自动化高：无需手动修改原始 Excel 文件
- ✅ 可扩展：可适配其他类似的列名格式问题

## 相关文件

- `app.py` - 后端主要逻辑
- `excel_processor.py` - Excel处理工具模块
- `static/mapping-cache.js` - 映射配置缓存功能
- `static/script.js` - 前端交互逻辑

## 更新日志

- **2026-02-12** - 初始版本，修复公式列名映射问题
